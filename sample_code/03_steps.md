!SLIDE smaller

# Step 1
## No indexes

    5 latest posts
    SELECT  `posts`.* FROM `posts`  ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+----------------+
    | id | select_type | table | type | possible_keys | key | key_len | ref | filtered | rows  |     Extra      |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+----------------+
    | 1  | SIMPLE      | posts | ALL  |               |     |         |     | 97924    | 100.0 | Using filesort |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+----------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.296479)

    5 latest published posts
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-----------------------------+
    | id | select_type | table | type | possible_keys | key | key_len | ref | filtered | rows  |            Extra            |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-----------------------------+
    | 1  | SIMPLE      | posts | ALL  |               |     |         |     | 97924    | 100.0 | Using where; Using filesort |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-----------------------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.292020)

!SLIDE smaller

# Step 2
## Index `created_at` column

    5 latest posts
    SELECT  `posts`.* FROM `posts`  ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
    | id | select_type | table | type  | possible_keys |            key            | key_len | ref | filtered |   rows    | Extra |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
    | 1  | SIMPLE      | posts | index |               | index_posts_on_created_at | 9       |     | 5        | 1907540.0 |       |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.001720)

    5 latest published posts
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------------+
    | id | select_type | table | type  | possible_keys |            key            | key_len | ref | filtered |   rows    |    Extra    |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------------+
    | 1  | SIMPLE      | posts | index |               | index_posts_on_created_at | 9       |     | 5        | 1907540.0 | Using where |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.001015)

!SLIDE smaller

# Step 3
## Index `published` column

    5 latest posts
    SELECT  `posts`.* FROM `posts`  ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
    | id | select_type | table | type  | possible_keys |            key            | key_len | ref | filtered |   rows    | Extra |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
    | 1  | SIMPLE      | posts | index |               | index_posts_on_created_at | 9       |     | 5        | 1856440.0 |       |
    +----+-------------+-------+-------+---------------+---------------------------+---------+-----+----------+-----------+-------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.001745)

    5 latest published posts
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
    | id | select_type | table | type  |      possible_keys       |            key            | key_len | ref | filtered |   rows   |    Extra    |
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
    | 1  | SIMPLE      | posts | index | index_posts_on_published | index_posts_on_created_at | 9       |     | 10       | 464110.0 | Using where |
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.000762)

## New index isn't being used - too small

!SLIDE smaller

# Step 4
## Queries with user model

    Posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 364
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-------------+
    | id | select_type | table | type | possible_keys | key | key_len | ref | filtered | rows  |    Extra    |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ALL  |               |     |         |     | 92822    | 100.0 | Using where |
    +----+-------------+-------+------+---------------+-----+---------+-----+----------+-------+-------------+
          user     system      total        real
      0.010000   0.000000   0.010000 (  0.292788)

    Published posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 364 AND `posts`.`published` = 1
    +----+-------------+-------+------+--------------------------+--------------------------+---------+-------+----------+-------+-------------+
    | id | select_type | table | type |      possible_keys       |           key            | key_len |  ref  | filtered | rows  |    Extra    |
    +----+-------------+-------+------+--------------------------+--------------------------+---------+-------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_published | index_posts_on_published | 2       | const | 46411    | 100.0 | Using where |
    +----+-------------+-------+------+--------------------------+--------------------------+---------+-------+----------+-------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.353386)

    5 latest published posts for a user
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 364 AND `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
    | id | select_type | table | type  |      possible_keys       |            key            | key_len | ref | filtered |   rows   |    Extra    |
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
    | 1  | SIMPLE      | posts | index | index_posts_on_published | index_posts_on_created_at | 9       |     | 10       | 464110.0 | Using where |
    +----+-------------+-------+-------+--------------------------+---------------------------+---------+-----+----------+----------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.705879)

!SLIDE smaller

# Step 5
## Index `user_id` column

    Posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 866
    +----+-------------+-------+------+------------------------+------------------------+---------+-------+----------+-------+-------------+
    | id | select_type | table | type |     possible_keys      |          key           | key_len |  ref  | filtered | rows  |    Extra    |
    +----+-------------+-------+------+------------------------+------------------------+---------+-------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_user_id | index_posts_on_user_id | 5       | const | 78       | 100.0 | Using where |
    +----+-------------+-------+------+------------------------+------------------------+---------+-------+----------+-------+-------------+
          user     system      total        real
      0.010000   0.000000   0.010000 (  0.004369)

    Published posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 866 AND `posts`.`published` = 1
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-------------------------------------------------------------------------------+
    | id | select_type | table |    type     |                  possible_keys                  |                       key                       | key_len | ref | filtered | rows  |                                     Extra                                     |
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-------------------------------------------------------------------------------+
    | 1  | SIMPLE      | posts | index_merge | index_posts_on_published,index_posts_on_user_id | index_posts_on_user_id,index_posts_on_published | 5,2     |     | 39       | 76.92 | Using intersect(index_posts_on_user_id,index_posts_on_published); Using where |
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-------------------------------------------------------------------------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.014671)

    5 latest published posts for a user
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 866 AND `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-----------------------------------------------------------------------------------------------+
    | id | select_type | table |    type     |                  possible_keys                  |                       key                       | key_len | ref | filtered | rows  |                                             Extra                                             |
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-----------------------------------------------------------------------------------------------+
    | 1  | SIMPLE      | posts | index_merge | index_posts_on_published,index_posts_on_user_id | index_posts_on_user_id,index_posts_on_published | 5,2     |     | 39       | 100.0 | Using intersect(index_posts_on_user_id,index_posts_on_published); Using where; Using filesort |
    +----+-------------+-------+-------------+-------------------------------------------------+-------------------------------------------------+---------+-----+----------+-------+-----------------------------------------------------------------------------------------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.010155)

!SLIDE smaller

# Step 6
## Index `user_id, published` columns
## Composite index

    Posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 735
    +----+-------------+-------+------+-------------------------------------------------------------+------------------------+---------+-------+----------+-------+-------------+
    | id | select_type | table | type |                        possible_keys                        |          key           | key_len |  ref  | filtered | rows  |    Extra    |
    +----+-------------+-------+------+-------------------------------------------------------------+------------------------+---------+-------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_user_id,index_posts_on_user_id_and_published | index_posts_on_user_id | 5       | const | 95       | 100.0 | Using where |
    +----+-------------+-------+------+-------------------------------------------------------------+------------------------+---------+-------+----------+-------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.003233)

    Published posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 735 AND `posts`.`published` = 1
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
    | id | select_type | table | type |                                    possible_keys                                     |                 key                  | key_len |     ref     | filtered | rows  |    Extra    |
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_published,index_posts_on_user_id,index_posts_on_user_id_and_published | index_posts_on_user_id_and_published | 7       | const,const | 34       | 100.0 | Using where |
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.002425)

    5 latest published posts for a user
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 735 AND `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
    | id | select_type | table | type |                                    possible_keys                                     |                 key                  | key_len |     ref     | filtered | rows  |            Extra            |
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_published,index_posts_on_user_id,index_posts_on_user_id_and_published | index_posts_on_user_id_and_published | 7       | const,const | 34       | 100.0 | Using where; Using filesort |
    +----+-------------+-------+------+--------------------------------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.001102)

!SLIDE smaller

# Step 6
## Remove `user_id` index
## Can use `user_id, published` index

    Posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 352
    +----+-------------+-------+------+--------------------------------------+--------------------------------------+---------+-------+----------+-------+-------------+
    | id | select_type | table | type |            possible_keys             |                 key                  | key_len |  ref  | filtered | rows  |    Extra    |
    +----+-------------+-------+------+--------------------------------------+--------------------------------------+---------+-------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_user_id_and_published | index_posts_on_user_id_and_published | 5       | const | 75       | 100.0 | Using where |
    +----+-------------+-------+------+--------------------------------------+--------------------------------------+---------+-------+----------+-------+-------------+
          user     system      total        real
      0.000000   0.000000   0.000000 (  0.004695)

    Published posts for a user
    SELECT `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 352 AND `posts`.`published` = 1
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
    | id | select_type | table | type |                         possible_keys                         |                 key                  | key_len |     ref     | filtered | rows  |    Extra    |
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_published,index_posts_on_user_id_and_published | index_posts_on_user_id_and_published | 7       | const,const | 33       | 100.0 | Using where |
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-------------+
          user     system      total        real
      0.000000   0.010000   0.010000 (  0.001554)

    5 latest published posts for a user
    SELECT  `posts`.* FROM `posts`  WHERE `posts`.`user_id` = 352 AND `posts`.`published` = 1 ORDER BY created_at DESC LIMIT 5
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
    | id | select_type | table | type |                         possible_keys                         |                 key                  | key_len |     ref     | filtered | rows  |            Extra            |
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
    | 1  | SIMPLE      | posts | ref  | index_posts_on_published,index_posts_on_user_id_and_published | index_posts_on_user_id_and_published | 7       | const,const | 33       | 100.0 | Using where; Using filesort |
    +----+-------------+-------+------+---------------------------------------------------------------+--------------------------------------+---------+-------------+----------+-------+-----------------------------+
          user     system      total        real
      0.010000   0.000000   0.010000 (  0.001021)
